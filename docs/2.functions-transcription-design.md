# 文字起こしバッチ処理 Functions 設計書

Batch Speech Transcription App

---

## 1. 目的・位置づけ

本ドキュメントは、音声アップロード UI で作成された「文字起こしジョブ」を処理する Azure Functions（バッチ文字起こし基盤）の設計を定義する。

本 Functions の役割:
- ジョブ単位での文字起こし処理
- 複数音声ファイルの並列処理
- 再実行・部分失敗に耐えるオーケストレーション
- 処理状態の永続化と可観測性の確保

---

## 2. 採用技術

| 項目 | 技術 |
| --- | --- |
| 実行基盤 | Azure Functions |
| ランタイム | .NET 8（Isolated） |
| オーケストレーション | Durable Functions |
| 音声保存 | Azure Blob Storage |
| キュー | Azure Queue Storage |
| 文字起こし | Azure AI Speech Service（Batch） |
| 永続化 | Azure Cosmos DB |
| ログ | Application Insights |

---

## 3. 全体アーキテクチャ概要

処理は「ジョブ単位」→「音声ファイル単位」の二段階で制御する。

1. UI がジョブを作成
2. ジョブ ID をトリガに Orchestrator を起動
3. 音声ファイル単位で並列文字起こし
4. 結果集約・ジョブ完了

---

## 4. 処理フロー概要

### 4.1 処理ステップ

1. ジョブ作成（UI / API）
2. ジョブ ID を Queue に投入
3. Orchestrator Function 起動
4. ジョブ情報取得
5. 音声ファイル一覧取得
6. Activity Function を並列実行
7. 文字起こし結果保存
8. ジョブ状態更新（Completed / Failed）

---

## 5. Functions 構成

### 5.1 Function 種別一覧

| 種別 | Function 名 | 役割 |
| --- | --- | --- |
| Trigger | JobQueueTrigger | ジョブ開始 |
| Orchestrator | TranscriptionOrchestrator | 全体制御 |
| Activity | TranscribeAudioActivity | 音声 1 件の文字起こし |
| Activity | SaveResultActivity | 結果保存 |
| Activity | UpdateJobStatusActivity | 状態更新 |

---

## 6. Orchestrator 設計

### 6.1 責務

- ジョブ単位の状態管理
- 音声ファイル単位の並列処理制御
- 失敗時の部分リトライ

### 6.2 状態遷移

```
Pending
↓
Processing
↓
Completed

または

Pending
↓
Processing
↓
PartiallyFailed / Failed
```

---

## 7. Activity Function 設計

### 7.1 TranscribeAudioActivity

**入力**
- JobId
- FileId
- BlobUrl

**処理内容**
- Blob Storage から音声取得
- Azure AI Speech Service に送信
- バッチ文字起こし実行
- 結果（テキスト + 信頼度）生成

**出力**
- FileId
- TranscriptText
- Confidence
- Status

### 7.2 SaveResultActivity

**処理内容**
- Transcriptions 保存（Cosmos DB）
- Blob Storage へ raw 結果保存（任意）

### 7.3 UpdateJobStatusActivity

**処理内容**
- Jobs の状態更新（Cosmos DB）
- 開始時刻・終了時刻の記録

---

## 8. 並列処理・スケーリング方針

- 音声ファイル単位で並列実行
- Durable Functions の fan-out / fan-in パターンを採用
- 並列実行数を2段階で制御：
  - **host.json**: `maxConcurrentActivityFunctions` でホスト全体のActivity並列数を制限（デフォルト: 10）
  - **オーケストレーター**: `DefaultMaxParallelFiles` 定数でジョブ内のファイル並列数を制限（デフォルト: 5）
- オーケストレーターはファイルをバッチ分割して順次処理
- スケールアウト時は複数インスタンスで異なるジョブを並列実行

**注意**: オーケストレーターの決定性を保つため、並列数の動的な設定変更には制限があります。
変更が必要な場合は、オーケストレーターの入力パラメータまたはActivity関数経由で取得する設計が必要です。

---

## 9. エラーハンドリング設計

| ケース | 方針 |
| --- | --- |
| 音声 1 件失敗 | 該当 File のみ Failed |
| 一部失敗 | ジョブは PartiallyFailed |
| 全失敗 | ジョブ Failed |
| 一時エラー | Durable の RetryOptions 使用 |

---

## 10. 再実行・冪等性

- FileId 単位で冪等制御
- 既に結果が存在する場合はスキップ可能
- Orchestrator 再実行でも二重登録しない設計

---

## 11. ログ・監視

- JobId / FileId を全ログに付与
- Application Insights でトレース
- 失敗率・処理時間をメトリクス化

---

## 12. 将来的な拡張

- 話者分離（Diarization）
- タイムコード付き文字起こし
- 複数言語対応
- 優先度付きジョブ

---

## 13. 設計方針まとめ

- UI と完全に疎結合
- ジョブ中心のドメイン設計
- 再実行・部分失敗を前提とする
- 運用を見据えた可観測性重視
